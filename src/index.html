<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <link rel="shortcut icon" href="/public/favicon.ico" />
  <link rel="apple-touch-icon" href="/public/logo192.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="/manifest.webmanifest" />
  
  <link href="./index.sass" rel="stylesheet">


  <style>
   #brainmap {
      position: absolute;
      right: 10px;
      top: 1100px;
      width: 400px;
      height: 400px;
    }
    #brainmappoints {
      position: absolute;
      right: 10px;
      z-index: 2;
      top: 1100px;
      width: 400px;
      height: 400px;
    }

  </style>

</head>
<body>
 
    <div id="menucontainer">
      <button id="connect">Connect to EEG</button>
      <button id="analyze">Analyze Data</button>
      <button id="stop">Stop Analyzing</button>
      <button id="record">Save CSV (does nothing)</button> 
      <input type="text" id="freqStart" placeholder="lower bound" value="0">
      <input type="text" id="freqEnd" placeholder="upper bound" value="100">
      <button id="bandPass">Set BandPass</button>
      <button id="graphmode">Graph Mode</button>
      <br><input type="text" id="channelView" placeholder="Format: 0,1,2,5,6,7,etc">
      <button id="setChannelView">Set Channel View</button>
      <input type="text" id="channelTags" placeholder="Format: 0:Fp1;2:Fz;6:P6:0,1,2;etc">
      <button id="setTags">Set Tags</button>
      Graph Mode
      <select id="graph">
        <option value="ffts" selected="selected">FFT Data</option>
        <option value="raw">ADC Data</option>
        <option value="coherence">Coherence Data</option>
      </select>
      Visual1
      <select id="vis1"> 
        <option value="smoothie" selected="selected">Scrolling Bandpowers</option>
        <option value="timecharts">Timecharts</option>
        <option value="spect">Spectrogram</option>
        <option value="bars">Bar Charts</option>
        <option value="brainmap">Brain Map</option>
        <option value="none">None</option>
      </select> 
      Visual2
      <select id="vis2"> 
        <option value="smoothie">Scrolling Bandpowers</option>
        <option value="timecharts">Timecharts</option>
        <option value="spect">Spectrogram</option>
        <option value="bars">Bar Charts</option>
        <option value="brainmap" selected="selected">Brain Map</option>
        <option value="none">None</option>
      </select> 
      Visual3
      <select id="vis3"> 
        <option value="smoothie">Scrolling Bandpowers</option>
        <option value="timecharts" selected="selected">Timecharts</option>
        <option value="spect">Spectrogram</option>
        <option value="bars">Bar Charts</option>
        <option value="brainmap">Brain Map</option>
        <option value="none">None</option>
      </select>
    </div>
    <div id="visualcontainer0">
      <h3 id="uplottitle">ADC FFTs w/ Bandpass</h3>
      <div id="adc"></div>
    </div>
    <div id="visualcontainer1">
      <div id="smoothiecontainer">
        <h3>Band Amplitudes. Color codes: Purple - Delta, Orange - Theta, Green - Alpha, Blue - Beta, Red - Gamma</h3>
        <canvas id="smoothie1" style="width: 75%; height: 200px"></canvas>
        <h3>Alpha Amplitudes (8-12Hz)</h3>
        <canvas id="smoothie2" style="width: 75%; height: 200px"></canvas>
      </div>
    </div>
    <div id="visualcontainer2">
      <div id="brainmapcontainer">
        <table id="brainmaptable">
          <tr><td><h3>Brain Map (see "atlas" in the console and set corresponding channel tags (see "channelTags")) | </h3></td>
          <td><h4>Viewing:</h4></td>
          <td><select id="bandview">
            <option value="scp">SCP (0.1Hz-1Hz)</option>
            <option value="delta">Delta (1Hz-4Hz)</option>
            <option value="theta">Theta (4Hz-8Hz)</option>
            <option value="alpha" selected="selected">Alpha (8Hz-12Hz)</option>
            <option value="beta">Beta (12Hz-35Hz)</option>
            <option value="lowgamma">Low Gamma (35Hz-48Hz)</option>
            <option value="highgamma">High Gamma (48Hz+)</option>
          </select></td></tr>
        </table>
        <canvas id="brainmap"></canvas>
        <canvas id="brainmappoints"></canvas>
      </div>
    </div>
    <div id="visualcontainer3">
      <div id="timechartStack"></div>
    </div>


<script src="./index.ts"></script>

<script>
  // https://developers.google.com/web/tools/workbox/modules/workbox-cli
  // it is needed because parcel will not recognize this as a file and not precess in its manner
  const sw = "./service-worker.js";

  navigator.serviceWorker
    .register(sw)
    .then(registration => {
      registration.onupdatefound = () => {
        const installingWorker = registration.installing;
        if (installingWorker == null) {
          return;
        }
        installingWorker.onstatechange = () => {
          if (installingWorker.state === "installed") {
            if (navigator.serviceWorker.controller) {
              console.log(
                "New content is available and will be used when all " +
                  "tabs for this page are closed. See https://bit.ly/CRA-PWA."
              );
            } else {
              console.log("Content is cached for offline use.");
            }
          }
        };
      };
    })
    .catch(error => {
      console.error("Error during service worker registration:", error);
    });

    
</script>

<script>

window.threads = 2; //Make multiple workers for big tasks
window.threadrot = 0;
  //WebWorker only works when hosted (e.g. with node)
  
  try {
    window.workers = [];
    for(var i = 0; i < window.threads; i++){
      window.workers.push(new Worker('./js/eegworker.js'));
      workers[i].onmessage = (e) => {
        var msg = e.data;
        //console.log(msg)
        receivedMsg(msg);
      };
    }
    console.log("worker threads: ", threads)
    
  }
  catch (err) {
    window.workers = undefined;
    //console.log(err);
  }

  
  //foo options: "xcor, autocor, cov1d, cov2d, sma, dft, multidft, multibandpassdft"
  window.postToWorker = (foo,input,workeridx = null) => {
    if(workeridx === null) {
      window.workers[window.threadrot].postMessage({foo:foo, input:input});
      if(window.threads > 1){
        window.threadrot++;
        if(window.threadrot >= window.threads){
          window.threadrot = 0;
        }
      }
    }
    else{
     window.workers[workeridx].postMessage({foo:foo, input:input});
    }
  }

</script>

</body>
</html>
